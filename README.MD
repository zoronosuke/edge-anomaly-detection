アプリを開発してください．ただ，データベースは今は使わなくていいです．csvファイルか，jsonファイルにいい感じに記録してほしいです．



# 📄 研究用システム設計ドキュメント

## 1．研究の目的

本研究では，**エッジデバイスが撮影した映像をリアルタイムでサーバに送信し，サーバ側で機械学習モデルにより「人の検出」を行い，異常があれば通知するシステム**を構築する．
具体的な目的は以下の通りである．

* **比較実験**

  * ローカル5Gとキャリア5Gにおける通信性能の比較
  * VPN利用の有無による遅延や安定性の評価
* **システム実証**

  * 複数のエッジデバイスから同時に送られるデータをサーバで処理可能にする
  * サーバ推論方式での帯域・遅延・通知精度を確認
* **応用可能性検証**

  * エッジAI＋通信基盤（ローカル5G/キャリア5G）の組み合わせが，監視・防犯・現場管理等のリアルタイム異常検知に有効かを明らかにする

---

## 2．システム全体構成（複数エッジデバイス対応）

### 2.1 アーキテクチャ概要

```
[複数Edge/Jetson Nano]
  ├─ カメラで1秒ごとに1フレーム取得
  ├─ JPEG圧縮（640×360, Q=80）
  ├─ HTTP POSTでサーバに送信
  └─ device_idで識別

           ⇣ ネットワーク（ローカル5G / キャリア5G / VPN）

[Server]
  ├ ingest API (FastAPI)
  │   └ 画像受信（device_id, ts 付き）
  ├ 推論モジュール (YOLOv8n / PyTorch)
  │   └ personクラスを検出（conf ≥ 0.5）
  ├ 通知モジュール
  │   └ LINE Messaging APIで警告通知
  ├ イベント管理
  │   └ 重複抑制・クールダウン（端末ごとに管理）
  └ 保存モジュール
      ├ DB（PostgreSQL）: 検知メタデータ保存
      └ S3互換ストレージ: 検出サムネイル保存
```

---

### 2.2 複数端末対応の工夫

* **device\_id必須**：各エッジデバイスから送信する際にユニークID（例：`jetson-001`）を付与
* **サーバ側辞書管理**：

  * `_last_alert_at[device_id]`
  * `_last_event_sig[device_id]`
    により，端末ごとにクールダウンと重複抑制を独立管理
* **データベース構造**：

  * `events (event_id, device_id, ts, person_count, anomaly_flag, image_url)`
    として，複数端末からのイベントを統一的に記録

---

## 3．データフロー

1. **エッジ処理**

   * カメラでフレーム取得（1fps）
   * JPEG圧縮（640×360, Q=80）
   * HTTP POST：`/ingest`

     * Body: 画像ファイル
     * Form: `device_id`, `ts`
     * Header: `X-Api-Key`

2. **サーバ処理**

   * FastAPIで受信
   * YOLOモデルで推論 → personクラスの有無を判定
   * イベント管理：端末ごとのクールダウン／重複抑制
   * LINE通知：異常時にBotアカウントから通知（Flex Message対応可）
   * DB保存：検知結果＋メタデータ
   * 画像保存：S3互換ストレージへ（後で参照可能）

3. **通知処理**

   * LINEメッセージ例：

     ```
     [人検出] device=jetson-001 count=2
     時刻: 2025-09-03 12:34:56
     ```
   * 将来はサムネイル画像のURLも添付

---

## 4．実験項目（研究として）

### 4.1 通信性能比較

* **条件**：

  * VPNなしローカル5G
  * VPNありローカル5G
  * VPNありキャリア5G
* **指標**：

  * レイテンシ（ping, HTTP応答時間）
  * スループット（iperf3）
  * ジッター／パケットロス率
  * 接続確立時間

### 4.2 システム性能検証

* 複数端末同時送信（例：3台, 5台, 10台）でサーバが処理可能か
* 1fps, 2fps, 5fps と送信周期を変化させた場合の帯域・CPU負荷・通知遅延
* 誤検知／未検知率の確認（モデル閾値調整）

### 4.3 応用実証

* 夜間や遠距離での検出性能
* ネットワーク障害時の再送挙動
* 通知の実運用有効性（スパム防止・クールダウン機能の効果）

---

## 5．使用技術

* **言語**：Python
* **エッジ**：Jetson Nano（OpenCV + Requests）
* **サーバ**：FastAPI + Uvicorn
* **モデル**：YOLOv8n (ultralytics)
* **通知**：LINE Messaging API
* **DB**：PostgreSQL（イベントログ管理）
* **ストレージ**：MinIO（S3互換）

---

## 6．研究の意義

* ローカル5Gとキャリア5Gの通信性能を，\*\*実際のエッジAIアプリケーション（人検出）\*\*の観点から比較できる．
* 複数エッジデバイスの同時接続を扱う設計により，**将来の大規模システム（監視・スマート工場等）に直結**する．
* 「サーバ推論方式」の限界（帯域・遅延）を明らかにでき，将来的に「ハイブリッド推論」へ移行する際の基礎データになる．

---

👉 このドキュメントをベースに，次は **システム図（ネットワーク構成図／データフロー図）を図解**するとより発表資料向きになります．

ご希望ですか？それともまずは **この文章をLaTeXレポート形式**にまとめ直しましょうか？
